# 5주차. 위치 탐지 기술 및 응용

## 5-3. 모바일 딥러닝 소개

- Conventional Processing Flow
  - 이미지 프레임들을 캡쳐를 해서 클라우드나 서버로 보내게 되고 이 서버에서 각종 딥 neural network 모델을 돌려서 인식하고자 하는 대상을 인식하게 되는 플로우를 지니게 됨
  - 이런 것들에 클라우드 기반의 처리에는 크게 두 가지 문제점을 가지고 있음
    - 프라이빗한 영상 데이터를 클라우드로 계속해서 전송해야 되는 문제
    - 영상데이터는 볼륨이 큰데 이런 볼륨이 큰 영상 데이터를 3G network, 셀룰러 network나 WifI를 통해서 지속적으로 전송해야 된다는 문제
  - 클라우드로 영상을 전송하지 않고 초소형 기기 모바일 기기나 웨어러블 기기 같은 소형기기에서도 딥러닝 모델을 수행해서 인식을 바로 할 수 있지는 않을까. 이런 기술에 대해서 많은 연구가 이루어지고 있음

-  Mobile GPU is Weak!

  - neural network processing 같은 경우 highly parral processing 이 필요하기 때문에 GPU를 많이 활용 하게 됨
  - 모바일 GPU는 모바일 기기들에 도입되고 있고 데스크탑 GPU에 비해 성능이 약하게 됨
  - 모바일 GPU에서 딥러닝 기반의 CNN을 익스큐션 했을 때와 데스크탑 GPU를 통해서 익스큐션 했을 때 그 성능 차이가 익스큐션 타임에 상당히 나게 됨

- Architecture is Different!

  - 모바일 GPU가 데스크탑 GPU에 비해서 성능이 굉장히 약할 뿐만 아니라 architecture한 특징도 다르게 가지게 됨. 이것을 고려해서 최적화를 해줘야 함
  - 데스크탑 GPU의 경우 GPU 안에 GPU 메모리를 따로 가지게 되고 거기에 한 번 데이터를 올리게 되면 GPU는 시스템의 다른 부분, CPU라든지 다른 프로세서와는 상관없이 독립적인 프로세싱을 진행할 수 있게 됨
  - 모바일 GPU의 경우 GPU와 CPU 그리고 다른 프로세스도 메모리를 쉐어하는 구조를 가지고 있기 때문에 메모리 밴드 위쓰가 작고 그 메모리를 쉐어해서 써야 되기 때문에 성능이 더 느려질 수 밖에 없는 특징 가지게 됨
  - 그래서 CNN을 convolutional neural network을 모바일에서 수행하려면 혹은 더 빠르게 수행하려면 어떻게 해야될까를 생각

- Identifying Latency Bottleneck

  - VGG 모델에 대해 분석을 진행해본 결과를 통해 살펴보면 convolutional layer가 다른 fully connected layer나 pooling layer에 비해서 수행 시간이 현저하게 크다는 것을 알 수 있음
  - 대략적으로 90%의 익스큐션 타임이 convolutional layer에서 이루어 사용된다라는 것을 알 수 있고 이 결과를 바탕으로 봤을 때 convolutional neural network 같은 경우 convolutional layer를 잘 옵티마이즈하는 게 전체 convolutional neural network의 실행을 빠르게 하는 데 도움이 된다라는 것을 알 수 있음
  - convolutional neural network의 실행에서 convolutional layer가 실행 저하의 괴앚ㅇ히 큰 시그니피컨트한 부분이라는 것을 알 수가 있는데 convolutional operation을 빠르게 수행하려면 어떻게 해야할까, 빠르게 수행하는 데 있어서 문제점들은 어떤 것이 있을까를 알아야함

- Problem 1 : High Memory Bandwidth Requirement

  - convolutional operation을 데스크탑 GPU를 활용해서 하는 방법은 general metrix multiplication(GEMM) 라이브러리를 활용하는 방법
  - 컨볼루셔널 커널이 있고 이 컨볼루셔널 커널을 이미지의 섭 영역에 계속해서 이미지의 섭 영역을 계속해서 옮겨가면서 다트 프로덕트를 하는 과정이 컨볼루셔널 오퍼레이션인데 이거를 컨볼루션 오퍼레이션으로 수행을 하지 않고 매트릭스 멀티 플리케이션으로 변환을 해서 수행하게 됨.
  - 어떻게 수행을 하게 되냐면 왼쪽 이미지의 서브 영역을 일렬로 이렇게 언폴딩을 해 주게 되는데 이 이미지를 매트릭스 multiplication 하기위한 새로운 아미지로 바꿔주게 되고 그 다음에 이 convolutional 커널도  1x1매트릭스로 피고나면 새로 생성된 매트릭스와 컨볼루셔널 커널을 표현하는 매트릭스 사이에 매트릭스 멀티플리케이션을 수행하게 되면 이 이미지에 대해 수행해야 되는 모든 컨볼루션 연산이 한 번에 수행됨.
  - 이 방법을 사람들이 많이 활용하는 이유는 매트릭스 멀티플리케이션에 대해 많은 옵티마이제이션이 이루어져있고 GEMM이 굉장히 빠르게 돌아가기 때문
  - 컨볼루셔널 연산을 매트릭스 멀티플리케이션으로 바꿔서 매트릭스 연산을 하게 되고 이걸 통해서 성능의 향상을 가져오는 방법을 많이 활용하고 있음
  - 이 방법은 데스크탑 GPU에서는 큰 문제가 되지 않았고 성능의 향상을 많이 가져왔는데 모바일 상황에서는 좋은 방법이 아님. 그 이유는 GEMM을 활용해서 컨볼루셔널 오퍼레이션을 수행하려면 잇풋 이미지를 매트릭스로 변환하는 과정이 필요한데 이 변환의 과정이라는 것은 메모리를 읽어가지고 리드를 해서 다시 쓰는 과정 필요. 그래서 이 매트릭스를 빌딩하는데 모바일 GPU는 메모리 연산이 굉장히 느리고 다른 프로세스들과 쉐어링을 함. 그래서 인풋 이미지를 GEMM을 하기 위한 매트릭스로 컨벌젼 하는 과정자체가 오버헤드
  - 또 다른 문제는 3x3라고 하면 이미지에 하나의 픽셀이 새로운 GEMM을 위한 메트릭스에 9번 카피되야함. 가운데에 있는 1을 생각하면 1이 다 한번 나타나야 하기에 대부분의 중앙에 있는 픽셀들의 경우 9번이 카피가 돼서 새로운 매트릭스에 들어가야 되는 문제가 있음. 당연히 메모리 오퍼레이션이 바틀넥이 되는 상황에서 9번의 추가적인 카피가 일어나야 되고 리드가 일어나야 된다는 것은 실행 속도에 영향을 미칠 수밖에 없게 됨.
  - 이런 GEMM 기반의 매트릭스 연산으로 컨볼루셔널 오퍼레이션을 바꿔서 푼 이유중에 하나가 GEMM이 굉장히 빠르고 좋다라는 가정 하에 했었다는 것. 모바일 GPU에서 돌아가는 좋은 GEMM 구현이 사실은 현재 많이 있지는 않아서 가정 자체가 성립하지 않게 되는 문제점.
  - 이런 여러 가지 문제를 봤을 때 모바일 GPU에서 컨볼루셔널 오퍼레이션을 하듯이 GEMM방식으로 바꿔서 푸는 연산을 하는 방식에 대해 다시한번 생각해 봐야 함.

- Problem 2 : Redundant Computation
  - 모바일에서의 응용을 살펴보면 컨티뉴어스비전 애플리케이션이 많음.

    ex. AR에서 비디오를 계속해서 비춰가면서 어떤 부분에 어떤 물건이 있는지 누가 있는지를 보는 애플리케이션

  - 기존의 애플리케이션에서는 한 번의 이미지를 찍어서 업로드를 하고 여기에 뭐가 있냐 물어봤지만 이제는 연속적인 이미지 프레임에 대해서 인식을 계속해서 해나가야 됨

  - 하지만 비디오의 프레임들 간에 중복이 많이 일어나게 됨

  - 급격하게 변하지 않는 신들에 대해 계속해서 딥 neural network 연산을 수행하게 되면 연산에 굉장히 많은 redundancy가 발생하게 됨

- Optimization : Mobile GPU-Aware Processing

  - 위의 문제점들을 해결하기 위해 convolutional operation을 GEMM으로 변환하지 않고 원래 하려던 방식대로 다이렉트 컨볼루션을 수행하는 방식으로 수행하고자 하는 연구들이 많이 있음
  - 컨볼루션 오퍼레이션을 FFT를 기반으로 어프록시메이션 해가지고 가속화하기 위한 기숙들도 있었고 모바일 GPU에 굉장히 작은 로컬캐쉬가 있음. 이 로컬캐쉬를 잘 활용해서 언볼루션 연산을 빠르게 하기 위한 기술들도 출현하고 있음
  - 숫자의 연산, 수의 표현의 정확도를 32비트에서 16비트로 하프플로팅 포인트를 활용해가지고 컨볼루셔널 오퍼레이션의 연산을 가속화하기위한 기술들도 제안되고 있음

- Optimization : Convolutional Caching

  - 여러 이미지 프레임 간의 연산의 redundancy를 해결하기 위한 기술도 소개가 되고 있음
  - 2개의 컨시큐티브 이미지가 있다 했을 때 그 두개의 이미지 사이의 시밀러리티르 ㄹ이미지의 섭 에어리어를 분석해서 만약 비슷한 이미지의 섭 영역이 있다하면 컨볼루셔널 연사을 굳이 다시 수행하지 ㅇ낳고 기존의 컨볼루셔널 연산을 재활용 하게 되고 만약에 두 개의 이미지 프레임 사이의 섭 영역이 굉장히 다르게 나타난다고 하면 컨볼루셔널 오퍼레이션을 수행하는 기술들도 제안

- Optimization : Matrix Decomposition

  - 매트릭스 연산을 큰 매트릭스 연산을 하나의 큰 매트릭스 연산으로 하는 게 아니라 여러 개의 작은 매트릭스 연산으로 나눠서 수행하게 도면 accuracy에 약간의 저하가 있을 수 있지만 연산을 훨씬 더 빠른 속도로 가솔화할 수 있다는 것을 알 수 있게 됨

- Summary

  - 딥 러닝 기술의 경우에 많은 연구, 응용 예제의 경우 accuracy가 중요한 경우가 많지만 또 다른 요소로 고려해야 될 것들이 시스템의 레이턴시, 파워 소모 등으 ㄹ고려해야 되고 이런 시스템 이슈들이 자우너 제약이 큰 모방리 기기, IoT 기기에서 딥러닝을 활용해야 되는 상황에서는 더욱 더 중요한 문제로 대두되게 됨
  - 딥러닝을 IoT나 모바일 환경의 인공지능 응용에 활용하기 위해서는 accuracy 문제 뿐만아니라 latency, 익스큐션의 속도, 파워 소모 이런 시스템 이슈들에 대해 관심을 갖고 최적화를 해주는 과정이 꼭 필요